---
title: Análise do protocolo SMPP usando o [!DNL Wireshark]
description: Descrição
solution: Campaign
product: Campaign
applies-to: Campaign Classic
keywords: KCS, SMPP, Wireshark
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Craig Thonis
article-created-date: 5/6/2022 3:51:03 PM
article-published-by: Craig Thonis
article-published-date: 5/6/2022 3:52:19 PM
version-number: 4
article-number: KA-17506
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=9319e64e-54cd-ec11-a7b5-6045bd00d4f5
exl-id: 39c89da2-36ae-4c66-9553-cfc3d5b4003a
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '2415'
ht-degree: 100%

---

# Análise do protocolo SMPP usando o [!DNL Wireshark]

## Descrição

<br>Saiba como analisar o tráfego SMPP usando o [!DNL Wireshark].<br><br><br><br><br>Introdução<br><br><br><br> <br><br>
A maioria dos SMS-C de alto rendimento são compatíveis com o protocolo SMPP versão 3.4. Este protocolo permite enviar SMS e receber informação sobre a entrega destes SMS. O protocolo SMPP está documentado na Especificação de Protocolo SMPP v3.4 disponível na Internet como um documento PDF.

Este artigo não substitui esta especificação: fornece dicas práticas sobre como interpretar a especificação do protocolo e combiná-la com a exibição do [!DNL Wireshark] para exibir para ajudar a solucionar problemas entre o Adobe Campaign e o parceiro de SMS-C.

Como o protocolo SMPP contém várias partes diferentes deixadas para a interpretação da equipe de implementação, há diferenças entre SMS-C distintos.

Ao solucionar problemas, sempre entre em contato com o parceiro de SMS-C para obter informações ou para ajudá-lo a verificar o que você obtém. Se o SMS-C responder com um erro, seu parceiro de SMS-C será a melhor pessoa para dizer por que ele respondeu com o erro. Se estiver usando um simulador SMPP em vez de se conectar a um SMS-C real, você deve usar o código fonte (ou um depurador) para entender o que está acontecendo.


## Resolução

<br><br>Captura de tráfego de rede sem [!DNL Wireshark]<br><br><br><br><br><br>
Se você não tiver acesso direto à máquina, talvez seja necessário capturar usando ferramentas de linha de comando como *tcpdump*. Se você já conhece a porta TCP da conexão, coloque o filtro correto para evitar capturar todo o tráfego. Esta é uma amostra da linha de comando `tcpdump` para capturar a porta `12345` a <b>`outfile.pcap`</b>:


| `tcpdump -i any -w outfile.pcap tcp port 12345` |
| --- |


O arquivo <b>`outfile.pcap`</b> pode ser aberto no [!DNL Wireshark] para fazer uma análise mais aprofundada.


Manipulação de <br><br>[!DNL Wireshark] <br><br><br><br> <br><br><br><br>
Este tópico pressupõe que você está familiarizado com as noções básicas do [!DNL Wireshark]: como capturar pacotes, definir filtros simples, ler detalhes do pacote. Uma breve introdução está disponível no [How-To Geek - Como usar o [!DNL Wireshark] para capturar, filtrar e inspecionar pacotes](https://www.howtogeek.com/104278/how-to-use-wireshark-to-capture-filter-and-inspect-packets/).

Para filtrar o tráfego SMPP no [!DNL Wireshark], há três recursos importantes:

- Use um filtro de exibição na porta do SMS-C. Por exemplo, se o SMS-C usar a porta `10000`, use o seguinte filtro:
   *`tcp.port == 10000`*


Para isolar pacotes por número de telefone ou por conteúdo de texto, use o recurso de pesquisa com as seguintes configurações:
![smpp1](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image/smpp1.png "smpp1")
- Use a ferramenta <b>Seguir fluxo de TCP</b> para isolar o fluxo em que você está trabalhando.
Feche a janela de texto vermelha/azul que aparece porque ela é útil somente para protocolos de texto que não são relevantes para SMPP.
   ![smpp2](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_964579199/smpp2.png "smpp2")



<br><br><br><br>Protocolo SMPP<br><br> <br><br>
O protocolo funciona por TCP e é totalmente binário, o que significa que ferramentas especiais como [!DNL Wireshark] (ou um editor hexadecimal) são necessários para descriptografar o conteúdo do fluxo.

O fluxo é composto de PDUs independentes: cada PDU é uma mensagem que contém um comando, um status, um número de sequência e outras informações com base no comando.

Devido à natureza do TCP como um protocolo de fluxo, um pacote TCP pode conter mais de uma PDU e as PDUs podem se estender por 2 ou mais pacotes TCP. O [!DNL Wireshark] remontará as PDUs corretamente, de modo que seja mais transparente para o usuário do [!DNL Wireshark].

Este é um exemplo de PDUs passando pela rede ao enviar um MT e depois receber um SR:
![smpp3](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_388497282/smpp3.png "smpp3")
Observação:

A lista de comandos padrão encontra-se na seção 5.1.2.1 da especificação SMPP (Conjunto de comandos SMPP).
<br><br><br><br><br><br>Respostas SMPP<br><br><br><br> <br><br>
O protocolo SMPP exige que todos os comandos sejam reconhecidos por uma PDU de resposta:

O `BIND_TRANSMITTER` é reconhecido por *`BIND_TRANSMITTER_RESP`*, o *`SUBMIT_SM`* é reconhecido por *`SUBMIT_SM_RESP`*, etc.

Existe um tempo limite para as respostas, normalmente é de 10, 30 ou 60 segundos. A resposta pode conter uma confirmação positiva (`command _status = 0`) ou um erro (consulte 5.1.3 *`command_status`*, *tabela 5-2* na especificação SMPP para ver a lista de erros padrão). Na maioria das vezes, essas respostas são imediatas e o tempo limite da resposta não é atingido.

Diferencie erros de resposta SMPP e códigos de erro SR: o mesmo código de erro pode significar coisas diferentes no erro de resposta ou no campo de erro SR. Ao relatar um código de erro, você deve ter muito cuidado sobre onde o encontrou, pois o significado do valor depende do seu contexto.
<br><br><br><br><br><br>Inicialização da conexão SMPP<br><br><br><br><br><br>
A conexão SMPP é iniciada pela conexão usando TCP. Depois, uma operação `BIND` é enviada pelo [!DNL Campaign]reconhecido por um `BIND RESP`. Estas operações são descritas na seção 4.1 da especificação SMPP (operação `BIND`).
![smpp4](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_468626174/smpp4.png "smpp4")
A operação de vínculo faz a verificação de login/senha e troca informações sobre o nome da plataforma, a versão e outros campos descritos na especificação.

Observação:

O logon pode ser encontrado no campo `system_id`.



No [!DNL Campaign], você deve ver um pacote do *`BIND_TRANSMITTER`* ao iniciar uma transferência MT e um pacote do *`BIND_RECEIVER`* quando o *`nlsm s`* aciona uma conexão MO/SR.

<b>Transmissor, receptor e transceptor: </b>o conector SMPP para Campaign Classic funciona em um modo transmissor/receptor separado: há duas conexões TCP, uma para transmitir MT e outra para receber MO e SR. Observe que a conexão TCP é sempre iniciada pelo [!DNL Campaign], mesmo para o modo receptor.

O SMPP também fornece um modo transceptor, mas esse modo não é implementado no conector SMPP para Campaign Classic.

O conector SMPP usa várias conexões em paralelo para transmitir o MT. Isso não pode ser controlado por causa da forma como o conector é projetado.
<br><br><br><br><br><br>Recebendo MO<br><br><br><br><br><br>
Quando o receptor está vinculado, o SMS-C pode enviar MO a qualquer momento. O MO é enviado usando uma PDU *`DELIVER_SM`* com bits 2-5 de *`esm_clas s`* claro (muitas vezes, o *`esm_class`* será simplesmente 0).
![smpp5](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_695769115/smpp5.png "smpp5")
A PDU *`DELIVER_SM`* deve ser respondida rapidamente por uma PDU *`DELIVER_SM_RESP`* com o mesmo *`sequence_number`*.
<br><br><br><br><br><br>Envio de MT<br><br><br><br><br><br>
Para enviar um MT, o transmissor deve ser vinculado com êxito. Antes de mais nada, verifique se o processo de vinculação foi executado com êxito.

O MT é enviado em uma PDU *`SUBMIT_SM`*. O SMS-C deve responder rapidamente com uma PDU *`SUBMIT_SM_RESP`*: esse pacote de resposta é especial porque contém a ID da mensagem no banco de dados do SMS-C (sempre inclua essa ID ao falar com o parceiro SMS-C para ajudá-lo a encontrar a mensagem mais rapidamente). Essa ID estará presente no SR e é a única maneira de corresponder o MT com seu SR correspondente.

O campo *`registered_delivery`* (descrito na seção 5.2.17 da especificação) indica ao SMS-C se é solicitado um SR para este MT específico. Se você não receber SR para uma mensagem específica, verifique se o campo está definido corretamente na PDU *`SUBMIT_SM`*.
![smpp5](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_1891077095/smpp5.png "smpp5")<br><br><br><br><br><br>Codificação de MT<br><br><br><br><br><br>
Cuidado:

A codificação de SMS é um assunto complexo com muitas armadilhas e várias implementações.


<br><br><br><br> <br><br>
A prática recomendada é sempre entrar em contato com o parceiro de SMS-C em caso de problemas de codificação. Seu parceiro de SMS tem um conhecimento preciso da codificação permitida e regras especiais que podem ser aplicadas devido a limitações em sua plataforma técnica. Faça com que eles verifiquem o que você envia para eles e o que eles enviam de volta, esse é o único caminho para uma interconexão bem-sucedida e estável.

As mensagens SMS usam uma codificação especial de sete bits, geralmente chamada de codificação GSM7. Consulte [!DNL Wikipedia] GSM 03.38 (em inglês).
<br><br><br><br> <br><br>
No protocolo SMPP, o texto GSM7 será expandido para oito bits por caractere para facilitar a solução de problemas. O SMS-C o compactará em 7 bits por caractere antes que seja enviado ao dispositivo móvel. Isso significa que o campo short_message do SMS pode ter até 160 bytes de comprimento no quadro SMPP, enquanto é limitado a 140 bytes quando enviado na rede móvel (o bit mais significativo é simplesmente descartado).

Em caso de problemas de codificação, veja alguns itens importantes a serem verificados:

- Primeiro, saiba quais caracteres pertencem a qual codificação. O GSM7 é famoso pelo seu apoio parcial a marcas diacríticas (acentos). Especialmente em francês, em que &quot;é&quot; e &quot;è&quot; fazem parte do GSM7, mas &quot;ê&quot;, &quot;â&quot; ou &quot;ï&quot; não fazem parte. A situação não é melhor quando se trata de espanhol.
- O C com cedilha (ç) está presente apenas em maiúsculas no alfabeto GSM7, mas alguns telefones o renderizam em minúsculas ou em letras maiúsculas “inteligentes”: a recomendação geral é evitar completamente e remover o cedilha (ainda é bem legível em francês) ou alternar para UCS-2.
- Não use ASCII no SMS, a menos que solicitado explicitamente pelo parceiro de SMS-C: essa codificação desperdiça espaço porque tem caracteres de 8 bits e menos cobertura do que o GSM7.
- O Latin-1 nem sempre é compatível: verifique a compatibilidade com seu parceiro de SMS-C antes de tentar usar Latin-1.
- As tabelas de correspondência de idiomas nacionais não são compatíveis com o conector do Adobe Campaign Classic. Em vez disso, você deve usar UCS-2.
- UCS-2 e UTF-16 são frequentemente misturados por telefones. Esse é um problema para as pessoas que enviam emoji e outros caracteres raramente usados que não estão presentes no UCS-2.
- A codificação GSM7 não é compatível com o [!DNL Wireshark]: caracteres especiais serão exibidos incorretamente. Se for necessário verificar se uma string GSM7 está corretamente codificada, você deve comparar códigos hexadecimais com a tabela GSM7.


O campo *`data_coding`* informa qual codificação é usada. O único problema é que o valor 0 significa a codificação padrão de SMS-C na especificação, mas em geral significa GSM7. Verifique com o parceiro de SMS-C *qual codificação está associada ao `data_coding = 0` (O Adobe Campaign é compatível apenas com o GSM7 para `data_coding* = 0`).

O tamanho máximo de uma mensagem depende de sua codificação. Esta tabela resume todas as informações relevantes:

<br><br><br><br> <br>

| Codificação | data_coding | Tamanho da mensagem (caracteres)  | Tamanho da parte para SMS multiparte  | Caracteres disponíveis  |
| --- | --- | --- | --- | --- |
| GSM7 | 0 | 160 | 152 | [Conjunto de caracteres básicos GSM7 + extensão](https://br.wikipedia.org/wiki/GSM_03.38) (caracteres estendidos ocupam 2 caracteres)  |
| Latino-1  | 3 | 140 | 134 | ISO-8859-1 |
| UCS-2 UTF-16  | 8 | 70 | 67 | Unicode (varia de telefone para telefone) |

<br><br><br><br><br>Cabeçalho de dados do usuário (UDH)<br><br><br><br><br><br>
O UDH (Cabeçalho de dados do usuário) é um pequeno cabeçalho binário adicionado ao texto de um SMS. Ele pode acionar recursos especiais como concatenação de SMS, tabelas de alternância de idioma nacional, logotipos/imagens (raramente usadas) ou push de WAP.

Como o UDH faz parte do campo de texto (campo SMPP short_message), ele reduz o tamanho efetivo de um SMS. Por exemplo, um UDH de SMS concatenado consumirá 6 bytes por parte do SMS (ou seja, 6 bytes reais de 8 bits, não caracteres de 7 bits), deixando espaço suficiente para apenas 152 caracteres de 7 bits por parte da mensagem.

O [!DNL Wikipedia] tem bons artigos sobre o Cabeçalho de dados do usuário e SMS concatenado (em inglês).

Para saber se uma short_message contém um UDH, verifique os bits 6 e 7 de esm_class (consulte a seção 5.2.12 da especificação). O [!DNL Wireshark] analisa o UDH na interface e fornece informações precisas.
![smpp7](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_738682084/smpp7.png "smpp7")
Na captura de tela acima, você pode ver o cabeçalho de dados do usuário no campo de mensagem (1), as informações contidas no UDH (2) e algumas informações extras não pertencentes ao pacote, mas computadas pelo [!DNL Wireshark] (3): o campo Short Message é especialmente interessante, pois contém a mensagem completa remontada pelo [!DNL Wireshark].
<br><br><br><br><br><br>Recebendo SR<br><br><br><br><br><br>
Quando o receptor está vinculado, o SMS-C pode enviar SR a qualquer momento. O SR é enviado usando um PDU DELIVER_SM com bits 2-5 de *`esm_class`*definido.
![smpp8](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_158644074/smpp8.png "smpp8")
O *`DELIVER_SM`* PDU deve ser respondido rapidamente pelo PDU *`DELIVER_SM_RESP`* com o mesmo *`sequence_number`*. Para encontrar o MT correspondente a este SR, procure por um *`SUBMIT_SM_RESP`* com a mesma ID. Por exemplo, este é o MT que corresponde ao SR:
![smpp9](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_1012110897/smpp9.png "smpp9")
O SR é enviado somente se o campo *`registered_delivery`* é definido no MT.

Observação:

O conector SMPP do Adobe Campaign Classic não lida com o SR que chega antes do pacote do *`SUBMIT_SM_RESP`*. A especificação não proíbe explicitamente esse comportamento, mas é considerada um comportamento incorreto (significaria que a mensagem foi recebida antes de ser enviada). Se você encontrar esse caso com muita frequência, peça ao seu parceiro de SMS-C para corrigir a plataforma dele.
<br><br><br><br><br><br>Decifrando o campo short_message do SR<br><br><br><br><br><br>
O campo de texto dos PDUs do SR tem uma codificação especial descrita no Apêndice B da especificação do protocolo SMPP. Infelizmente, esse formato é apenas uma recomendação sem fazer parte do protocolo, mesmo que a maioria dos SMS-C respeitem mais ou menos esse mesmo formato.

Você deve solicitar diretamente ao parceiro de SMS-C uma documentação de sua própria implementação e verificar novamente se ela corresponde ao que você vê no [!DNL Wireshark]. Na maioria das vezes, os implementadores de SMS-C nem conhecem sua implementação e isso gera problemas e mal-entendidos. Não hesite em solicitar ajuda ao parceiro de SMS-C caso tenha dúvidas sobre esse campo (especialmente os códigos de erro).

O formato básico é o seguinte:

*`id:IIIIIIIIII sub:SSS dlvrd:DDD submit date:YYMMDDhhmm done date:YYMMDDhhmm stat:DDDDDDD err:EEE`*

*`Text:........`*

Estas são as diretrizes gerais para a leitura da linha acima:

- A id é a mesma que foi enviada no *`SUBMIT_SM_RESP`* do MT correspondente.
- Você pode ignorar problemas no campo `text`: este campo é ignorado pelo [!DNL Campaign] porque não é útil, não é confiável e pode até ser completamente ilegível se o SMS foi enviado usando outra codificação que não ASCII alfanumérico puro. Este comportamento é normal.
- Os nomes de campos não diferenciam maiúsculas de minúsculas (por exemplo, `id`: `sub`: `Text`: pode também ser referido como `ID`: `SUB`: `text`:).
- O campo *`dlvrd`* geralmente não é confiável, a menos que documentado pelo parceiro de SMS-C.
- As datas podem ter qualquer fuso horário, tornando-as praticamente inúteis, ou simplesmente estão incorretas porque o relógio do servidor remoto está desligado.
- O campo *`stat`* pode ter outros valores que não os definidos no apêndice B. Use o senso comum e a documentação do parceiro de SMSC para entender seu significado.
- O campo *`err`* é totalmente dependente do SMS-C e, na maioria das vezes, é documentado pelo parceiro de SMS-C. Geralmente, o código 000 significa sucesso, enquanto qualquer outro código indica erros. O campo geralmente é numérico, mas também pode ser hexadecimal.

<br><br><br><br><br><br>Vários SRs para o mesmo MT<br><br><br><br><br><br>
Alguns SMS-Cs enviam vários SRs para o mesmo MT para rastrear o progresso do MT na rede. Isso é inútil porque, na maioria das vezes, o cliente deseja saber apenas quando a mensagem foi recebida (geralmente, esse é o último SR).

Na dúvida, trabalhe somente no último SR recebido do SMS-C para encontrar o estado de uma mensagem.
<br><br><br><br><br><br>Janela SMPP<br><br><br><br><br><br>
Como as operações e respostas são assíncronas, você pode otimizar as taxas de transferência enviando vários PDUs de operação antes de aguardar as respostas. O número de mensagens que não têm resposta é chamado de janela.

Exemplo de transmissão com uma janela máxima de 4:
![smpp10](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_2072040949/smpp10.png "smpp10")
A implementação atual não controla a janela e espera que o SMS-C remoto seja rápido o suficiente para lidar com o MT.
