---
title: Migrar usuários, grupos e ACLs entre instâncias AEM
description: Descrição
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: 'Helpx Link: https://helpx.adobe.com/experience-manager/kb/migrate-users-groups-ACLs.html ; Contains Docs links that may need to be changed'
bug: false
article-created-by: Gucci Paull
article-created-date: 6/21/2022 6:07:06 PM
article-published-by: Gucci Paull
article-published-date: 6/21/2022 6:07:59 PM
version-number: 8
article-number: KA-16448
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=d7ce3bf2-8cf1-ec11-bb3d-6045bd015716
exl-id: 5c285ad4-da35-4ee4-b3d1-3ac9eea5f5b2
source-git-commit: af761579c3fb5e51cf5f4d144bff0e058fd13911
workflow-type: tm+mt
source-wordcount: '960'
ht-degree: 1%

---

# Migrar usuários, grupos e ACLs entre instâncias AEM

## Descrição

Como migrar usuários e grupos com permissões de ACL no AEM de um servidor para outro ou de uma instância de AEM para outra.

## Resolução

**Etapa 1: Encontre os usuários admin e anônimos**

1. Vá para o aplicativo CRXDE lite `/crx/de/index.jsp` e fazer logon como usuário administrador (no sistema de origem).
1. Vá para &quot;Ferramentas&quot; = &quot;Consulta&quot;.
1. Na caixa inferior &quot;Query&quot;, digite esta consulta para encontrar o usuário administrador: *`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="admin" .`*
1. Clique em &quot;Executar&quot; e copie o caminho do nó do usuário administrador nos resultados para um arquivo de texto.
1. Repita a etapa 3 com uma consulta para usuário anônimo: *`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="anonymous" .`*
1. Clique em &quot;Executar&quot; e copie o caminho do nó do usuário anônimo nos resultados para um arquivo de texto (agora você tem dois caminhos, um para &quot;admin&quot; e outro para &quot;anonymous&quot;).

   Por exemplo:

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv` - usuário administrador no sistema de origem

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib` - usuário anônimo no sistema de origem

**Etapa 2A: Migrar usuários e grupos (usando `crx2oak` ou `oak-upgrade`)**

Usuários e grupos podem ser migrados entre instâncias AEM usando o [crx2oak](https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/using-crx2oak.html) ou [oak-upgrade](https://jackrabbit.apache.org/oak/docs/migration.html) ferramentas.

1. Baixe o `crx2oak` ou `oak-upgrade` jar correspondente à versão do Oak que você está usando: 
   1. Oak-upgrade: [https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade)
   1. Crx2Oak: [Repositório Maven](https://mvnrepository.com/artifact/com.adobe.granite/crx2oak?repo=adobe-public)
1. Fazer upload do arquivo jar para o servidor AEM
1. Parar AEM (instâncias de origem e de destino)
1. Substitua o nome do arquivo jar no comando abaixo.
1. Substituir *`/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib`* no *`--exclude-paths`* parâmetro part do comando abaixo com os caminhos dos usuários admin e anonymous do seu sistema de origem.
1. Modifique os caminhos na linha para corresponderem à sua instância (adicione *`segment-old:`* antes do caminho, se necessário, consulte aqui [https://jackrabbit.apache.org/oak/docs/migration.html](https://jackrabbit.apache.org/oak/docs/migration.html)): *`/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository`*
1. Em seguida, execute o comando no shell do servidor.

   ```
   java -Xms2g -Xmx2g -jar oak-upgrade-1.8.12.jar \
   --include-paths=/home \
   --merge-paths=/home \
   --exclude-paths=/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib,/home/groups/a/administrators,/home/groups/a/analytics-administrators,/home/groups/c/community-moderators,/home/groups/c/content-authors,/home/groups/c/contributor,/home/groups/community/community-groupadmin,/home/groups/community/community-sitecontentmanager,/home/groups/community/community-sitemembers,/home/groups/d/dam-users,/home/groups/default/order-administrators,/home/groups/e/everyone,/home/groups/f/forms-users,/home/groups/forms/fd-administrators,/home/groups/forms/forms-users,/home/groups/geometrixx,/home/groups/media,/home/groups/o/operators,/home/groups/projects,/home/groups/t/tag-administrators,/home/groups/t/target-activity-authors,/home/groups/u/user-administrators,/home/groups/w/workflow-editors,/home/groups/w/workflow-users,/home/users/a/admin,/home/users/a/anonymous,/home/users/mac,/home/users/media,/home/users/projects,/home/users/system,/home/rep:policy,/home/users/rep:policy,/home/groups/rep:policy \
   segment-old:/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository  upgradeusers.log &
   ```

1. Depois de concluído, vá para a etapa 3 para migrar as ACLs.  Caso não seja possível migrar usando o `crx2oak` em seguida, siga as etapas de migração de pacote abaixo.

**Etapa 2B: Migrar usuários e grupos (usando pacotes)**

Se os usuários não foram importados automaticamente por meio da autenticação LDAP / SAML ou `CRX2Oak` (método A acima) é possível empacotar usuários e grupos.  Nesse caso, você cria dois pacotes separados no sistema antigo (excluindo usuários prontos para uso admin e anônimos).

1. Copie o caminho dos nós de usuário anônimos e admin dos resultados na Etapa 1 (&quot;Encontrar os usuários admin e anonymous&quot;) acima.

   Por exemplo:

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv` - usuário administrador no sistema em que estou criando o pacote

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib` - usuário anônimo no sistema em que estou criando o pacote

1. Vá para o &quot;Gerenciador de pacotes&quot;, *`http://host:port/crx/packmgr/index.jsp`* e faça logon como administrador.
1. Criar pacote &quot;usuários&quot;
1. Adicione um filtro à configuração de pacote para `/home/users` com essas regras de exclusão (no `/home/users` filtro):
   1. `exclude /home/users/.\*/.tokens`
   1. `exclude /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`
   1. `exclude /home/users/K/Kj1406Qo9IDODc_nk5Ib`
   1. `exclude /home/users/a/admin`
   1. `exclude /home/users/a/anonymous`
   1. `exclude /home/users/system`
   1. `exclude /home/users/geometrixx`
   1. `exclude /home/users/media`
   1. `exclude /home/users/projects`
   1. `exclude /home/users/mac`
1. Crie o pacote.
1. Baixe o pacote.
1. Descompacte o arquivo zip do pacote no seu computador: `jar -xvf users.zip META-INF/vault/filter.xml`
1. Abra o arquivo `META-INF/vault/filter.xml` em um editor de texto.
1. Adicionar `mode="merge"` para a tag filter ... , por exemplo:

   ```
   ?xml version="1.0" encoding="UTF-8"?    workspaceFilter version="1.0"    filter root="/home/users" mode="merge"    exclude pattern="/home/users/.*/.tokens"/    exclude pattern="/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv"/    exclude pattern="/home/users/K/Kj1406Qo9IDODc_nk5Ib"/    exclude pattern="/home/users/a/admin"/    exclude pattern="/home/users/a/anonymous"/    exclude pattern="/home/users/system"/    exclude pattern="/home/users/geometrixx"/    exclude pattern="/home/users/media"/    exclude pattern="/home/users/projects"/    exclude pattern="/home/users/mac"/    /filter    /workspaceFilter
   ```

1. Volte a compactar o conteúdo modificado do pacote em zip para incluir a alteração.

   ```
   jar -uvf users.zip META-INF/vault/filter.xml
   ```

1. Crie um pacote &quot;grupos&quot; que contenha uma regra de filtro `/home/groups`.
1. Repita as etapas 11 a 14 para o pacote de grupos.
1. (Somente atualização) Se estiver executando a migração para a versão mais recente do AEM, instale uma nova instância AEM local *da versão antiga*(com nosamplecontent), instale o pacote users e depois o pacote groups lá. Em seguida, execute uma atualização no local para a nova versão nessa instância. Isso converte os usuários para a nova representação do Oak. Após a atualização no local, reempacote os usuários novamente para exportá-los para a instância atualizada pretendida. Faça o mesmo para os grupos de usuários.
1. Instale o pacote de usuários no novo sistema.
1. Instale o pacote de grupos no novo sistema.
1. Se você estiver migrando de uma versão mais antiga do AEM para a 6.3, acesse o `/useradmin` IU e adicione o receptor de replicação do usuário ao grupo &quot;administradores&quot;.

**Etapa 3. Migrar ACLs**

Se você conseguir instalar ferramentas (ACS Commons) para AEM, siga estas etapas:

1. Baixe e instale o ACS Commons.
1. Siga as etapas fornecidas aqui para criar um pacote ACL.
1. Vá para http://aem-host:port/crx/packmgr/index.jsp and fazer logon como administrador.
1. Clique no pacote ACL.
1. Clique em Editar.
1. Selecione o [!UICONTROL Avançado] (veja a captura de tela abaixo).
1. No menu suspenso Manuseio de AC, selecione [!UICONTROL Mesclar] para evitar a remoção de ACLs existentes no sistema de destino. Isso é especialmente importante ao migrar ACLs entre diferentes versões do AEM (já que evita a remoção de ACLs prontas para uso).

Se você *not* É possível instalar ferramentas (ACS Commons) para AEM e, em seguida, seguir essas etapas. Observe que a máquina na qual você executa esses comandos deve ser o Mac OS, [!DNL Linux]ou [!DNL Windows] (usando [!DNL Cygwin]) com cURL, [!DNL Python]e [!DNL Java] SDK instalado.

1. Vá para http://src-aem-host:port/crx/packmgr/index.jsp and fazer logon como administrador.
1. Crie um pacote chamado &quot;ACL-migration&quot;
1. Clique no botão Edit .
1. Selecione o [!UICONTROL Avançado] e defina o modo Manuseio de AC para Mesclar.
1. Salvar.
1. Crie o pacote e baixe-o.
1. No sistema de arquivos, execute este comando no pacote para extrair o `META-INF/vault/filter.xml` arquivo: 

   ```
   jar -xvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. No mesmo diretório, execute este comando para baixar um arquivo json dos caminhos ACL em `/content` na instância de origem (defina o nome de usuário e a senha e o host correto): 

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/content//element(*,rep:ACL)&showResults=true'  data.json
   ```

1. Criar um arquivo `generate-package-filter.py` e cole o [!DNL Python] código abaixo: 

   ```
   import json
   from pprint import pprint
   
   with open ('data.json') as data_file:
      data = json.load(data_file)
   
   print("?xml version=\"1.0\" encoding=\"UTF-8\"?")
   print("workspaceFilter version=\"1.0\"")
   
   for item in data "results":
       print("filter root=\"{path}\" /" . format(path=item "path"))
   
   print( "/workspaceFilter")
   ```

1. Execute o [!DNL Python] script da mesma pasta em que data.json foi criado e salve a saída em `META-INF/vault/filter.xml` (substituindo o conteúdo existente de `filter.xml`): 

   ```
   python generate-packge-filter.py  META-INF/vault/filter.xml
   ```

1. Use este comando para atualizar o `filter.xml` no arquivo zip:

   ```
   jar -uvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. Faça upload do arquivo zip para o gerenciador de pacotes da instância de origem: http://src-aem-host:port/crx/packmgr/index.jsp
1. Clique em [!UICONTROL Criar] ou [!UICONTROL Recriar] para criar o pacote.
1. Baixe o pacote do servidor de AEM de origem.
1. Faça upload do pacote para o gerenciador de pacotes do servidor de AEM de destino: http://dst-aem-host:port/crx/packmgr/index.jsp
1. Clique em [!UICONTROL Instalar] para instalá-lo.
1. Repita as etapas 8 a 16 para qualquer outro caminho que altere o comando curl de caminho. Por exemplo, isso obteria as ACLs em `/etc` em vez de `/content`:

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/etc//element(*,rep:ACL)&showResults=true'  data.json` |
   ```
