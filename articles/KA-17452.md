---
title: "Obter despejos de threads de uma JVM"
description: Descrição
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: “KCS”
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 6:41:42 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 6:48:01 PM"
version-number: 1
article-number: KA-17452
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=2e54c459-d531-ec11-b6e5-000d3a5ba97a"
exl-id: 9ad0fefe-b974-45d9-95b6-4a90f691f0cb
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '1052'
ht-degree: 0%

---

# Obter despejos de encadeamento de uma JVM

## Descrição

<br><br><br>Como posso obter despejos de encadeamentos de uma JVM em [!DNL Linux], UNIX ou [!DNL Windows]?<br><br><br><br> <br><br>
Um despejo de encadeamento é uma lista de todos os [!DNL Java] threads que atualmente estão ativos em um [!DNL Java Virtual Machine] (JVM).

Há várias maneiras de obter despejos de encadeamentos de uma JVM. É altamente recomendável ter mais de um despejo de thread. Uma boa prática é realizar 10 despejos de encadeamento em um intervalo regular (por exemplo, um despejo de encadeamento a cada dez segundos).


## Resolução

<br><br>Etapa 1: Obtenha o PID do seu [!DNL Java] processo<br><br><br><br> <br><br>
A primeira informação que você precisará para obter um despejo de encadeamento é sua [!DNL Java] PID do processo.

O [!DNL Java] O JDK acompanha o comando jps, que lista todos os [!DNL Java] ids de processo. Você pode executar este comando da seguinte maneira:


```
jps -l 70660 sun.tools.jps.Jps 70305
```


<b>Observação:</b> Em [!DNL Linux] e UNIX, talvez seja necessário executar esse comando como `sudo -u user jps -l`, onde &quot;usuário&quot; é o nome de usuário do usuário que a função [!DNL Java] O processo está sendo executado como.

Se isso não funcionar ou você ainda não conseguir encontrar o [!DNL Java] processo, (caminho não definido, JDK não instalado ou mais antigo [!DNL Java] versão), use

- UNIX, [!DNL Linux]e Mac OS X: `ps -el | grep java`
- [!DNL Windows]: Pressione Ctrl+Shift+Esc para abrir o gerenciador de tarefas e encontrar o PID do [!DNL Java] processo

<br><br><br><br><br><br>Etapa 2: Solicitar um despejo de thread da JVM<br><br><br><br><br><br><br><br>
<b>pilha</b>

Se estiver instalado/disponível, recomendamos usar o <b>pilha</b> ferramenta. Ele imprime dumps de encadeamento no console da linha de comando.

Para obter um despejo de thread usando jstack, execute o seguinte comando:
`jstack -l pid`

Você pode enviar dumps de encadeamento consecutivos para um arquivo usando a diretiva de redirecionamento/anexação de saída do console:
`jstack -l pid  threaddumps.log`

Notas:

- A ferramenta jstack está disponível desde o JDK 1.5 (para JVM em [!DNL Windows], está disponível somente em algumas versões do JDK 1.5 e JDK 1.6).
- jstack funciona mesmo se a variável `-Xrs` parâmetro jvm está ativado
- Não é possível usar a ferramenta jstack do JDK 1.6 para obter despejos de encadeamento de um processo em execução no JDK 1.5.
- Em [!DNL Linux] e UNIX, você precisa executar o comando como o usuário proprietário do processo java:

   `sudo -u *java-user* jstack -l *pid*`  

   (java-user deve ser substituído pela id do usuário que a função [!DNL Java] o processo está sendo executado como)
- Em [!DNL Windows], se você executar o jstack e receber o erro &quot;Não há armazenamento suficiente disponível para processar esse comando&quot;, deverá executar o jstack como o usuário do Windows SYSTEM ou o usuário que possui o processo java.  Você pode fazer isso usando o psexec, que pode ser baixado [here](http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx). Para executar o jstack como usuário SYSTEM, use um comando como este:

   `psexec -s jstack *pid*   threaddumps.log`

   Se não conseguir instalar o psexec no servidor, você poderá criar um arquivo .bat contendo o comando e executá-lo [usando o [!DNL Windows] agendador de tarefas (como um usuário diferente)](https://technet.microsoft.com/en-us/library/cc748993%28v=ws.11%29.aspx).
- Se o processo java não estiver respondendo, às vezes pode ajudar a usar a opção <b>`-J-d64`</b> (em sistemas de 64 bits), por exemplo:

   `jstack -J-d64 -l *pid*  threaddumps.log`
- Se o comando jstack (`jstack -l pid  threaddumps.log`) aciona o erro 1 abaixo e, em seguida, executa o comando como o usuário proprietário do processo java.  Por exemplo:

   `sudo -u sling jstack -l pid  threaddumps.log`



<br><br><br><br><br><br> <br><br><br><br>

```
Error attaching to process: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

sun.jvm.hotspot.debugger.DebuggerException: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

...

Caused by: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

...

sun.jvm.hotspot.debugger.linux.LinuxDebuggerLocal$LinuxDebuggerLocalWorkerThread.run(LinuxDebuggerLocal.java:138)
```



<br><br>SCRIPT JSTACK<br><br>
Aqui está um [script](https://github.com/cqsupport/jstackSeries.sh/blob/master/jstackSeries.sh) (adaptado a partir da [eclipse.org](http://wiki.eclipse.org/How_to_report_a_deadlock#jstackSeries_--_jstack_sampling_in_fixed_time_intervals_.28tested_on_Linux.29)) que usará uma série de despejos de encadeamento jstack.  Também utiliza o uso da cpu no nível do thread usando o comando superior.

Faça assim:
`sudo -u *user*jstackSeries.sh *pid* *aemserveruser* *count* *delay*`

Por exemplo:
`sudo -u aemuser jstackSeries.sh 1234 aemserveruser 10 3`

- <b>1234</b> é o pid do [!DNL Java] processo
- <b>cq5serveruser</b> é [!DNL Linux] ou usuário UNIX que [!DNL Java] o processo é executado como
- <b>10º</b> é quantos despejos de encadeamento utilizar
- <b>3</b> é o atraso entre cada despejo


<b>Observação: </b>A saída superior tem a id de thread nativa em formato decimal, enquanto a saída de jstack tem a nid em hexadecimal.  Você pode corresponder o thread de cpu alto da saída superior à saída de jstack convertendo o id do thread em hexadecimal.

Além do script acima, também temos um [[!DNL Windows] Script Powershell e um Adobe AEM script específico no github](https://github.com/cqsupport/jstackSeries.sh).

<b>Ferramenta de despejo de encadeamento para Adobe Experience Manager</b>

Se você estiver usando o produto Adobe Experience Manager, é possível instalar [esta ferramenta](https://helpx.adobe.com/experience-manager/kb/thread-dumps-collection-analysis.html) para ter uma interface de usuário simples para gerar despejos de encadeamento.
<br><br>MANEIRAS ALTERNATIVAS DE OBTER UM DESPEJO DE ENCADEAMENTO<br><br>
Se a variável <b>pilha</b> A ferramenta não está disponível para você, então é possível obter despejos de encadeamento da seguinte maneira:

<b>Observação:</b> Algumas ferramentas não podem obter despejos de threads da JVM se o parâmetro da linha de comando `-Xrs` estiver ativado. Se tiver problemas para obter despejos de encadeamento, verifique se essa opção está habilitada.
<br><br>UNIX, Mac OS X e [!DNL Linux] (JDK 1.4 ou versão inferior)<br><br>
No UNIX, Mac OS X e [!DNL Linux], você pode enviar um sinal de QUIT para o [!DNL Java] processo para informá-lo a enviar um despejo de thread para saída padrão.

1. Execute este comando para fazer isso:

   `kill -QUIT *pid*`

   Talvez seja necessário executar esse comando como `sudo -u user kill -QUIT *pid*` onde &quot;usuário&quot; é o usuário que [!DNL Java] O processo está sendo executado como.
2. Se você estiver iniciando o CQSE usando o `crx-quickstart/server/start` em seguida, seus dumps de encadeamento serão enviados para `crx-quickstart/server/logs/startup.log`. Se você estiver usando um servidor de aplicativos de terceiros, como o JBoss, [!DNL WebSphere], [!DNL Tomcat]ou outro, consulte a documentação do servidor para descobrir a qual arquivo o resultado padrão é direcionado.

[!DNL Windows]:<br><br>JDK 1.X
1. Baixe javadump.exe (anexado abaixo).
2. Inicie a JVM com estes três argumentos (eles devem estar na ordem correta):

   `-XX:+UnlockDiagnosticVMOptions -XX:+LogVMOutput -XX:LogFile=*C:\temp\jvmoutput.log*`
3. Pressione Ctrl+Shift+Esc para abrir o Gerenciador de tarefas.
4. Encontre o PID do [!DNL Java] processo.
5. Na linha de comando, execute

   `javadump.exe *pid*`
6. O despejo de encadeamento aparecerá no `jvmoutput.log` arquivo mencionado na etapa 2.

<br><br>JDK 1.6<br><br>
Obter um despejo de thread de <b>jconsole</b> usando um plug-in: 0

Veja como solicitar um despejo de encadeamento:

1. Adicione o seguinte parâmetro ao jvm em execução `Communique` : `-Dcom.sun.management.jmxremote`
2. Baixe e instale o JDK 1.6 (se ainda não tiver sido feito).
3. Baixe e extraia o [Utilitário Analisador de despejo de encadeamento](https://github.com/irockel/tda). 1
4. Executar `jconsole.exe` do JDK 1.6:

                               `jconsole.exe -pluginpath /path/to/file/tda.jar`
5. Clique no botão <b>Despejos de thread</b> guia .
6. Clique no botão <b>Solicitar despejo de encadeamento</b> link .

<b>Observação:</b> Se você estiver executando AEM 6.\* e para observar os threads em execução, você pode solicitar `http://host:port/system/console/status-Threads` para obter uma lista de encadeamentos. No entanto, observe que esses dumps de encadeamento não funcionarão com ferramentas de análise de despejo de encadeamento, como samurai ou tda.<br><br>Aplica-se a<br><br>
Todos os produtos Adobe em execução em uma JVM
<br><br>Ferramentas de análise de despejo de encadeamento:<br><br>
0 [http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx](http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx)
1  [https://github.com/irockel/tda](https://github.com/irockel/tda)
2 [https://fastthread.io/](https://fastthread.io/)
3 [https://www.ibm.com/support/knowledgecenter/en/SSLLVC_5.0.0/com.ibm.esupport.tool.tmda.doc/docs/readme.htm](https://www.ibm.com/support/knowledgecenter/en/SSLLVC_5.0.0/com.ibm.esupport.tool.tmda.doc/docs/readme.htm)
